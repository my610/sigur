p_sigur = Proto("sigur", "SIGUR Protocol")

sigurTypes = {
	[0] = "MSGTYPE_ASYNC",
	[1] = "MSGTYPE_REQUEST",
	[2] = "MSGTYPE_REPLY"
}

sigurCodes = {
	[1] = "GATE_LOGIN_REQUEST",
	[2] = "GATE_LOGIN_REPLY",
	[5] = "GATE_ASYNC_SENDDEVSTATES",
	[9] = "GATE_ASYNC_NEWDEV",
	[10] = "GATE_ASYNC_DELDEV",
	[12] = "GATE_RELOADDB_REQUEST",
	[13] = "GATE_RELOADDB_REPLY",
	[20] = "GATE_ASYNC_RESETDEVICE",
	[24] = "GATE_ASYNC_HWCONFCHANGED",
	[29] = "GATE_PING_REQUEST",
	[30] = "GATE_PING_REPLY",
	[34] = "GATE_ASYNC_CURRENTTIME",
	[36] = "GATE_ASYNC_SETTRACERTARGET",
	[38] = "GATE_ASYNC_SETDEVMEMBYTE",
	[39] = "GATE_ASYNC_MEMMONSTART",
	[40] = "GATE_ASYNC_MEMMONSTOP",
	[41] = "GATE_ASYNC_MEMMONREGION",
	[47] = "GATE_EXTMEMREAD_REQUEST",
	[48] = "GATE_ASYNC_EXTMEMREADDATA",
	[49] = "GATE_EXTMEMREAD_REPLY",
	[50] = "GATE_EXTMEMWRITE_REQUEST",
	[51] = "GATE_ASYNC_EXTMEMWRITEPROGRESS",
	[52] = "GATE_EXTMEMWRITE_REPLY",
	[53] = "GATE_ASYNC_EXTMEMREADCANCEL",
	[54] = "GATE_ASYNC_EXTMEMWRITECANCEL",
	[55] = "GATE_GETVAR_REQUEST",
	[56] = "GATE_GETVAR_REPLY",
	[58] = "GATE_ASYNC_APBCHANGENOTIFY",
	[62] = "GATE_ASYNC_DUMPDB",
	[66] = "GATE_ASYNC_DEVEVENT2",
	[68] = "GATE_ASYNC_DEVVARSUPDATE",
	[69] = "GATE_ASYNC_CHADEVNOTIFY",
	[70] = "GATE_ASYNC_SUBSCRIBEEMPEVENTS",
	[71] = "GATE_ASYNC_UNSUBSCRIBEEMPEVENTS",
	[72] = "GATE_ASYNC_EMPEVENT",
	[73] = "GATE_ASYNC_EMPIDXUPDATENOTIFY",
	[74] = "GATE_QUERYMODSTATUS_REQUEST",
	[75] = "GATE_QUERYMODSTATUS_REPLY",
	[76] = "GATE_QUERYOBJSTATUS_REQUEST",
	[77] = "GATE_QUERYOBJSTATUS_REPLY",
	[78] = "GATE_PREACTIVATION_REQUEST",
	[79] = "GATE_PREACTIVATION_REPLY",
	[80] = "GATE_ACTIVATION_REQUEST",
	[81] = "GATE_ACTIVATION_REPLY",
	[82] = "GATE_ASYNC_EMPTMPLOCK",
	[83] = "GATE_ASYNC_EMPTMPUNLOCK",
	[84] = "GATE_ASYNC_EMPLOCATIONUPDATE2",
	[85] = "GATE_ASYNC_DEVICESTATEGROUP",
	[86] = "GATE_ASYNC_DEVICEQUALUPDGROUP",
	[87] = "GATE_ASYNC_SETDEVMODEGROUP",
	[88] = "GATE_ASYNC_SETDEVEVENTMASKGROUP",
	[89] = "GATE_GETVARGROUP_REQUEST",
	[90] = "GATE_GETVARGROUP_REPLY",
	[91] = "GATE_OEMREADHASP_REQUEST",
	[92] = "GATE_OEMREADHASP_REPLY",
	[93] = "GATE_OEMWRITEHASP_REQUEST",
	[94] = "GATE_OEMWRITEHASP_REPLY",
	[95] = "GATE_GET_HASP_ID_REQUEST",
	[96] = "GATE_GET_HASP_ID_REPLY",
	[97] = "GATE_CONNDIAG_REQUEST",
	[98] = "GATE_CONNDIAG_REPLY",
	[99] = "GATE_GETPINBYKEY_REQUEST",
	[100] = "GATE_GETPINBYKEY_REPLY",
	[101] = "GATE_RAMMEMREAD_REQUEST",
	[102] = "GATE_ASYNC_RAMMEMREADDATA",
	[103] = "GATE_RAMMEMREAD_REPLY",
	[104] = "GATE_ASYNC_SYNCCOND",
	[105] = "GATE_HELLO_REQUEST",
	[106] = "GATE_HELLO_REPLY",
	[107] = "GATE_LOGINV3_REQUEST",
	[108] = "GATE_LOGINV3_REPLY",
	[109] = "GATE_ASYNC_DEVEVENT3",
	[110] = "GATE_ASYNC_DEBUGDUMP",
	[111] = "GATE_USERLOG_REQUEST",
	[112] = "GATE_USERLOG_REPLY",
	[113] = "GATE_CHAUSERPASS_REQUEST",
	[114] = "GATE_CHAUSERPASS_REPLY",
	[115] = "GATE_ASYNC_DEVEVENT3A",
	[116] = "GATE_DBSELECT_REQUEST",
	[117] = "GATE_DBSELECT_REPLY",
	[118] = "GATE_ASYNC_OPRACTION",
	[119] = "GATE_ASYNC_SETPORT",
	[120] = "GATE_ASYNC_REMOTEKD",
	[121] = "GATE_ASYNC_SYNCEMP",
	[122] = "GATE_LOCKOPERATION_REQUEST",
	[122] = "GATE_ASYNC_REMOTEKD2",
	[123] = "GATE_LOCKOPERATION_REPLY",
	[124] = "GATE_ENUMEXTEVENTS_REQUEST",
	[125] = "GATE_ENUMEXTEVENTS_REPLY",
	[126] = "GATE_ASYNC_SUBEXTEVENTS",
	[127] = "GATE_ASYNC_UNSUBEXTEVENTS",
	[128] = "GATE_ASYNC_EXTEVENT",
	[129] = "GATE_ASYNC_SETALARMLINESSTATE",
	[130] = "GATE_TRASSIRHTTP_REQUEST",
	[131] = "GATE_TRASSIRHTTP_REPLY",
	[132] = "GATE_ASYNC_CHECKTRASSIRPARAMS",
	[133] = "GATE_DB_UPDATE_REQUEST",
	[134] = "GATE_DB_UPDATE_REPLY",
	[138] = "GATE_IIDK_REQUEST",
	[139] = "GATE_IIDK_REPLY",
	[141] = "GATE_ASYNC_CHECKDOMAVTOPARAMS",
	[142] = "GATE_TESTLONG_REQUEST",
	[143] = "GATE_TESTLONG_REPLY",
	[144] = "GATE_ASYNC_CANCELREQUEST",
	[145] = "GATE_ASYNC_ADFORCECHECK",
	[147] = "GATE_ASYNC_SENDSMS",
	[148] = "GATE_ASYNC_SMSCHANGENOTIFY",
	[157] = "GATE_MISCGETPERSAUTOID_REQUEST",
	[158] = "GATE_MISCGETPERSAUTOID_REPLY",
	[159] = "GATE_ASYNC_PROCESSPASS",
	[160] = "GATE_ASYNC_CHECKMACROSCOPPARAMS",
	[161] = "GATE_ASYNC_CHECKGLOBALS",
	[162] = "GATE_ODBCTEST_REQUEST",
	[163] = "GATE_ODBCTEST_REPLY",
	[164] = "GATE_ASYNC_CHECKEXTDBSYNCPARAMS",
	[165] = "GATE_ASYNC_REQUESTSINGLESYNC",
	[168] = "GATE_GETBINDATA_REQUEST",
	[169] = "GATE_GETBINDATA_REPLY",
	[170] = "GATE_ONECORGANIZATIONS_REQUEST",
	[171] = "GATE_ONECORGANIZATIONS_REPLY",
	[172] = "GATE_ASYNC_MISCMES_DBGSETSUBSCR",
	[173] = "GATE_ASYNC_MISCMES_DBGSENDMSG",
	[174] = "GATE_ASYNC_MISCMES_DBGNOTIFY",
	[175] = "GATE_ASYNC_MISCMES_PARAMSCHA",
	[176] = "GATE_ASYNC_MISCMES_ACTIONREQ",
	[177] = "GATE_ASYNC_MISCMES_NOTIFY",
	[178] = "GATE_ASYNC_FRAMESGRABBERSYNC",
	[179] = "GATE_ASYNC_FRAMESGRABBEREVENTEMUL",
	[180] = "GATE_MODBUSDBGCOMMAND_REQUEST",
	[181] = "GATE_MODBUSDBGCOMMAND_REPLY",
	[182] = "GATE_ASYNC_MISCNP_MANUALLPR",
	[183] = "GATE_ASYNC_MISCNP_TESTPASS",
	[184] = "GATE_ASYNC_ALM_SYNC",
	[185] = "GATE_ASYNC_ALM_STATEUPDATE",
	[186] = "GATE_ASYNC_BSUPDATE",
	[187] = "GATE_BSTEMPLATE_REQUEST",
	[188] = "GATE_BSTEMPLATE_REPLY",
	[189] = "GATE_ASYNC_ALM_CMD",
	[190] = "GATE_ASYNC_ALM_SENDSTATES",
	[191] = "GATE_ASYNC_CHECKRULEPOLICIES",
	[193] = "GATE_ASYNC_MISCSAP_PARAMSCHA",
	[194] = "GATE_ASYNC_MOVEEMPTOZONE",
	[195] = "GATE_NFCTERMINAL_REQUEST",
	[196] = "GATE_NFCTERMINAL_REPLY",
	[198] = "GATE_ASYNC_SALTO_SHIP_PARAM_CHANGED",
	[199] = "GATE_ASYNC_SALTO_SHIP_SYNC_STATUS",
	[200] = "GATE_ASYNC_SALTO_SHIP_EMP_UPDATED",
	[201] = "GATE_ASYNC_SALTO_SHIP_SET_DOOR_MODE",
	[202] = "GATE_SALTO_SHIP_KEYENC_REQUEST",
	[203] = "GATE_SALTO_SHIP_KEYENC_REPLY",
	[204] = "GATE_ASYNC_CHECKNOMEROKPARAMS",
	[205] = "GATE_GETEMPSLOCATION_REQUEST",
	[205] = "GATE_ASYNC_CHECKAPERIOPARAMS",
	[206] = "GATE_GETEMPSLOCATION_REPLY",
	[206] = "GATE_ASYNC_APERIO_DOOR_COMMAND",
	[207] = "GATE_GETCPFINFO_REQUEST",
	[208] = "GATE_GETCPFINFO_REPLY",
	[209] = "GATE_ASYNC_MISCMOLOCKERS",
	[210] = "GATE_ASYNC_MISCMOLOCKERS_STATUSUPDATE",
	[211] = "GATE_ASYNC_STATUSMNGR_CMD",
	[212] = "GATE_ASYNC_STATUSMNGR_REPORT",
	[213] = "GATE_PAYTRANS_REQUEST",
	[214] = "GATE_PAYTRANS_REPLY",
	[215] = "GATE_BS_TEMPLATE_IDENTIFY_REQUEST",
	[216] = "GATE_BS_TEMPLATE_IDENTIFY_REPLY",
	[217] = "GATE_ASYNC_MISC_MPARKING",
	[218] = "GATE_ASYNC_ZONES_DELETED",
	[219] = "GATE_ASYNC_ZONES_CHANGED",
	[220] = "GATE_ASYNC_BSREWRITE",
	[221] = "GATE_ASYNC_SV_DOOR_COMMAND",
	[222] = "GATE_ASYNC_SV_CHECKPARAMS",
	[223] = "GATE_SYNCDB_REQUEST",
	[224] = "GATE_SYNCDB_REPLY",
	[225] = "GATE_ASYNC_LOGSTREAM_SUBSCRIBE",
	[226] = "GATE_ASYNC_LOGSTREAM_UNSUBSCRIBE",
	[227] = "GATE_LOGSTREAM_GETLID_REQUEST",
	[228] = "GATE_LOGSTREAM_GETLID_REPLY",
	[229] = "GATE_ASYNC_LOGSTREAM_NOTIFICATION",
	[230] = "GATE_SENDALLEMPLOCATION_REQUEST",
	[231] = "GATE_SENDALLEMPLOCATION_REPLY",
	[232] = "GATE_ASYNC_EMPLOCATION_UPDATE",
	[233] = "GATE_ASYNC_TEST_EMAIL",
	[234] = "GATE_ASYNC_CHECKINTELLECTPARAMS",
	[235] = "GATE_MISCSTOPLISTGPN_REQUEST",
	[236] = "GATE_MISCSTOPLISTGPN_REPLY",
	[237] = "GATE_ASYNC_CHECKSIDEPARAMS",
	[238] = "GATE_ELNANODEVICES_REQUEST",
	[239] = "GATE_ELNANODEVICES_REPLY",
	[240] = "GATE_ASYNC_ELLOCATEDEVICE",
	[241] = "GATE_ELTEMPLATE_REQUEST",
	[242] = "GATE_ELTEMPLATE_REPLY",
	[243] = "GATE_ASYNC_ELUPDATEDEVICES",
	[244] = "GATE_ASYNC_ELUPDATEDEVICESDATA",
	[247] = "GATE_ASYNC_MISC_IGSREGUPDATED",
	[248] = "GATE_ASYNC_SEND_EMP_NTFY",
	[249] = "GATE_TELEGRAM_GCID_REQUEST",
	[250] = "GATE_TELEGRAM_GCID_REPLY",
	[251] = "GATE_ASYNC_TELEGRAM_GCID_UPD",
	[252] = "GATE_ASYNC_SYNCDBSTATE_UPD",
	[253] = "GATE_ASYNC_CHECK_FACE_PHOTO",
	[254] = "GATE_ASYNC_CHECKAUTOMARSHALPARAMS",
	[255] = "GATE_ASYNC_DEBUGPROMET",
	[256] = "GATE_ASYNC_MISCALGONT_NOTIFY",
	[257] = "GATE_MISCALGONT_REQUEST",
	[258] = "GATE_MISCALGONT_REPLY",
	[259] = "GATE_ASYNC_LICENCE_UPDATE",
	[260] = "GATE_LICENCE_REQUEST",
	[261] = "GATE_LICENCE_REPLY",
	[262] = "GATE_GETCEINFO_REQUEST",
	[263] = "GATE_GETCEINFO_REPLY",
	[264] = "GATE_GETAPINFO_REQUEST",
	[265] = "GATE_GETAPINFO_REPLY",
	[266] = "GATE_GETEMPINFO_REQUEST",
	[267] = "GATE_GETEMPINFO_REPLY",
	[268] = "GATE_ASYNC_SUBEMPS_START",
	[269] = "GATE_ASYNC_SUBEMPS_UPDATE",
	[270] = "GATE_ASYNC_SUBCE",
	[271] = "GATE_ASYNC_CE",
	[273] = "GATE_ASYNC_EXEC_ON_CLIENT",
	[274] = "GATE_ASYNC_MISCTABPARK_UPDATED",
	[275] = "GATE_CHAUSERPASSV2_REQUEST",
	[276] = "GATE_CHAUSERPASSV2_REPLY",
	[277] = "GATE_NOTIFY_REQUEST",
	[278] = "GATE_NOTIFY_REPLY",
	[279] = "GATE_ASYNC_NOTIFY",
	[280] = "GATE_SVWHITELIST_BEGINSYNC_REQUEST",
	[281] = "GATE_SVWHITELIST_BEGINSYNC_REPLY",
	[282] = "GATE_ASYNC_SVWHITELIST_PROGRESS",
	[283] = "GATE_ASYNC_ANVIZUPDATE",
	[284] = "GATE_ASYNC_ANVIZREWRITE",
	[285] = "GATE_ONECQUERYTEST_REQUEST",
	[286] = "GATE_ONECQUERYTEST_REPLY",
	[287] = "GATE_ASYNC_ONECQUERYTEST_DATA",
	[288] = "GATE_ASYNC_ONECQUERYTEST_CMD",
	[289] = "GATE_ASYNC_TRIGGER_EVENT",
	[290] = "GATE_KEYGUARD_REQUEST",
	[291] = "GATE_KEYGUARD_REPLY",
	[292] = "GATE_ASYNC_KEYGUARD_NOTIFY",
	[293] = "GATE_ASYNC_KEYGUARD_CLIENT_NOTIFY",
	[294] = "GATE_ASYNC_EMPS_UPDATED",
	[295] = "GATE_ASYNC_EMPS_DELETED",
	[296] = "GATE_DBJSON_REQUEST",
	[297] = "GATE_DBJSON_REPLY",
	[298] = "GATE_MR_REQUEST",
	[299] = "GATE_MR_REPLY",
	[300] = "GATE_ACCESSPOLICY_REQUEST",
	[301] = "GATE_ACCESSPOLICY_REPLY",
	[302] = "GATE_ASYNC_REGPASS",
	[303] = "GATE_ASYNC_BASIP_NOTIFY",
	[304] = "GATE_ASYNC_CHECKNTECHPARAMS",
	[305] = "GATE_GETEMPMONINFO_REQUEST",
	[306] = "GATE_GETEMPMONINFO_REPLY",
	[307] = "GATE_GETEMPPHOTO_REQUEST",
	[308] = "GATE_GETEMPPHOTO_REPLY",
	[309] = "GATE_OSDP_SETCOMPARAM_REQUEST",
	[310] = "GATE_OSDP_SETCOMPARAM_REPLY",
	[311] = "GATE_OSDP_SETENCPARAM_REQUEST",
	[312] = "GATE_OSDP_SETENCPARAM_REPLY",
	[313] = "GATE_ASYNC_CHECKISSPARAMS",
	[314] = "GATE_ASYNC_VZORMQTT_SUBSCRIPTION",
	[315] = "GATE_ASYNC_VZORMQTT_INCOMINGDATA",
	[316] = "GATE_VZORMQTT_PUB_REQUEST",
	[317] = "GATE_VZORMQTT_PUB_REPLY",
	[318] = "GATE_ASYNC_VZORUPDATE",
	[319] = "GATE_HTTPCURL_REQUEST",
	[320] = "GATE_HTTPCURL_REPLY",
	[321] = "GATE_ASYNC_MISC_QUAR_UPD",
	[322] = "GATE_ASYNC_MISCZONEDEPRESTRUPD",
	[323] = "GATE_ASYNC_CHECKCCTVSERVERS"
}

local f_msg_len = ProtoField.uint32("sigur.msg.len", "Len", base.DEC)
local f_msg_type = ProtoField.uint32("sigur.msg.type", "Type", base.DEC, sigurTypes)
local f_msg_trid = ProtoField.uint32("sigur.msg.trid", "Trid", base.HEX)
local f_msg_code = ProtoField.uint32("sigur.msg.code", "Code", base.DEC, sigurCodes)

local f_pl_len   = ProtoField.uint32("sigur.pl_len", "Payload Length")
local f_payload  = ProtoField.bytes("sigur.payload", "Payload", base.BYTES)

p_sigur.fields = { f_msg_len, f_msg_type, f_msg_trid, f_msg_code, f_pl_len, f_payload }

function p_sigur.dissector(buf, pinfo, tree)
	if buf:len() == 0 then return end
	
	local pktlen = buf:reported_length_remaining()
	local pos = 0
	local pktCount = 0
	local sigur_types = {}
	
	pinfo.cols.protocol = p_sigur.name
	sigur_root = tree:add(p_sigur)

    while pos < pktlen do
		
		pktCount = pktCount + 1
		local msg_len = buf(pos, 4):uint()
	
		local type_str = sigurTypes[buf(pos + 4, 4):uint()]
		if type_str == nil then type_str = "Unknown" end
		table.insert(sigur_types, type_str)
	
		local s_code = sigurCodes[buf(pos + 12, 4):uint()]
		
		subtree = sigur_root:add("SIGUR type: " .. type_str .. " code: " .. s_code)

		subtree:add(f_msg_len,  msg_len)
		subtree:add(f_msg_type, buf(pos + 4, 4):uint())
		subtree:add(f_msg_trid, buf(pos + 8, 4):uint())
		subtree:add(f_msg_code, buf(pos + 12, 4):uint())
		
		local pl_len = msg_len - 16
		if pl_len > 0 then
			subtree:add(f_pl_len, pl_len)
			subtree:add(f_payload, buf(pos + 16, pl_len))
			pos = pos + msg_len
		end
    end

	pinfo.cols.info = string.format("Sigur (%d):[ %s ]", pktCount, table.concat(sigur_types, ", "))
end

do
	local tcp_port_table = DissectorTable.get("tcp.port")
	for i,port in ipairs{3308} do
		tcp_port_table:add(port, p_sigur)
	end
end
